/* ============================================================
   CORE: storage.js
   –õ–û–ö–ê–õ–¨–ù–ï –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø + –ê–í–¢–û–ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø
   –ü—Ä–∞—Ü—é—î –∑ –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º DATA (—î–¥–∏–Ω–∏–π JSON)
============================================================ */

import { DATA } from "./data.js";
import { renderAll } from "../modules/render.js";
import { syncQueuePush } from "./sync.js";

/* ------------------------------------------------------------
   1. –ö–ª—é—á —É –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å—Ö–æ–≤–∏—â—ñ
------------------------------------------------------------ */
const STORAGE_KEY = "quail_pro_mode_data";

/* ------------------------------------------------------------
   2. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
------------------------------------------------------------ */
export function loadLocal() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);

        if (!raw) {
            console.log("‚ÑπÔ∏è LOCAL: –ü–æ—Ä–æ–∂–Ω—å–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ñ DATA.");
            return;
        }

        const obj = JSON.parse(raw);

        // –ü–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ DATA (—î–¥–∏–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
        Object.assign(DATA, obj);

        console.log("‚úÖ LOCAL: –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ.");
        renderAll();
    }
    catch (e) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ loadLocal():", e);
    }
}

/* ------------------------------------------------------------
   3. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—Ä—É—á–Ω—É
------------------------------------------------------------ */
export function saveLocal() {
    try {
        const raw = JSON.stringify(DATA);
        localStorage.setItem(STORAGE_KEY, raw);

        console.log("üíæ LOCAL: –ó–±–µ—Ä–µ–∂–µ–Ω–æ.");
    }
    catch (e) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ saveLocal():", e);
    }
}

/* ------------------------------------------------------------
   4. –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑ –¥–µ–±–∞—É–Ω—Å–æ–º
------------------------------------------------------------ */
let autosaveTimer = null;

export function autosave() {
    if (autosaveTimer) clearTimeout(autosaveTimer);

    autosaveTimer = setTimeout(() => {
        saveLocal();
        syncQueuePush(DATA);   // –¥–æ–¥–∞—î–º–æ –≤ —á–µ—Ä–≥—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
        console.log("‚öôÔ∏è AUTOSAVE –≤–∏–∫–æ–Ω–∞–Ω–æ");
    }, 300);
}

/* ------------------------------------------------------------
   5. –ü–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö
------------------------------------------------------------ */
export function clearLocalStorage() {
    localStorage.removeItem(STORAGE_KEY);
    console.warn("‚ö†Ô∏è LOCAL: –î–∞–Ω—ñ –≤–∏–¥–∞–ª–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–µ–Ω reload.");
}