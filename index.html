// ============================
//      –¢–ï–ú–ê (–Ω—ñ—á / –¥–µ–Ω—å)
// ============================
const themeSwitch = document.getElementById("themeSwitch");
if (themeSwitch) {
  themeSwitch.addEventListener("click", () => {
    document.body.classList.toggle("light");
    themeSwitch.textContent = document.body.classList.contains("light") ? "‚òÄÔ∏è" : "üåô";
  });
}

// ============================
//      –ù–ê–í–Ü–ì–ê–¶–Ü–Ø
// ============================
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const page = btn.dataset.page;
    if (!page) return;

    document.querySelectorAll(".page").forEach(p => p.classList.remove("active-page"));
    const target = document.getElementById("page-" + page);
    if (target) target.classList.add("active-page");

    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});

// ============================
//      –ö–û–ú–ü–û–ù–ï–ù–¢–ò –ö–û–†–ú–£
// ============================
const feedComponents = [
  ["–ö—É–∫—É—Ä—É–¥–∑–∞", 10],
  ["–ü—à–µ–Ω–∏—Ü—è", 5],
  ["–Ø—á–º—ñ–Ω—å", 1.5],
  ["–°–æ–µ–≤–∞ –º–∞–∫—É—Ö–∞", 3],
  ["–°–æ–Ω—è—à–Ω–∏–∫–æ–≤–∞ –º–∞–∫—É—Ö–∞", 2.5],
  ["–†–∏–±–Ω–µ –±–æ—Ä–æ—à–Ω–æ", 1],
  ["–î—Ä—ñ–∂–¥–∂—ñ", 0.7],
  ["–¢—Ä–∏–∫–∞–ª—å—Ü—ñ–π—Ñ–æ—Å—Ñ–∞—Ç", 0.5],
  ["Dolfos D", 0.7],
  ["–°—ñ–ª—å", 0.05]
];

// ============================
//      –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –ö–û–†–ú–£ (–ù–ï –ß–Ü–ü–ê–Æ)
// ============================
function loadFeedTable() {
  const tbody = document.getElementById("feedTable");
  if (!tbody) return;

  let html = "";
  feedComponents.forEach((item, i) => {
    const price = localStorage.getItem("price_" + i) || 0;
    const qty = localStorage.getItem("qty_" + i) ?? item[1];

    html += `
      <tr>
        <td>${item[0]}</td>
        <td><input class="qty" data-i="${i}" type="number" value="${qty}"></td>
        <td><input class="price" data-i="${i}" type="number" value="${price}"></td>
        <td id="sum_${i}">0</td>
      </tr>`;
  });

  tbody.innerHTML = html;
  calculateFeed();

  document.querySelectorAll(".qty, .price, #feedVolume")
    .forEach(el => el.addEventListener("input", calculateFeed));
}

function calculateFeed() {
  let total = 0;
  let totalKg = 0;

  feedComponents.forEach((item, i) => {
    const qty = Number(document.querySelector(`.qty[data-i="${i}"]`)?.value) || 0;
    const price = Number(document.querySelector(`.price[data-i="${i}"]`)?.value) || 0;

    localStorage.setItem("qty_" + i, qty);
    localStorage.setItem("price_" + i, price);

    const sum = qty * price;
    total += sum;
    totalKg += qty;

    const sumCell = document.getElementById("sum_" + i);
    if (sumCell) sumCell.textContent = sum.toFixed(2);
  });

  const perKg = totalKg ? total / totalKg : 0;
  const volume = Number(document.getElementById("feedVolume")?.value) || 0;

  document.getElementById("feedTotal").textContent = total.toFixed(2);
  document.getElementById("feedPerKg").textContent = perKg.toFixed(2);
  document.getElementById("feedVolumeTotal").textContent = (perKg * volume).toFixed(2);
}

loadFeedTable();

// ============================
//      –Ø–ô–¶–Ø ‚Äî –ù–ê–ö–û–ü–ò–ß–ï–ù–ù–Ø
// ============================
let eggs = JSON.parse(localStorage.getItem("eggs") || "{}");
let eggsCarry = JSON.parse(localStorage.getItem("eggsCarry") || "{}");

if (typeof eggsCarry.carry !== "number") eggsCarry.carry = 0;
if (typeof eggsCarry.totalTrays !== "number") eggsCarry.totalTrays = 0;

function sortDatesAsc(dates) {
  return dates.slice().sort((a, b) => a.localeCompare(b));
}

function recomputeEggsAccumulation() {
  const dates = sortDatesAsc(Object.keys(eggs));
  let carry = 0;
  let totalTrays = 0;

  dates.forEach(d => {
    const e = eggs[d];
    const commercial = Math.max((e.good || 0) - (e.bad || 0) - (e.home || 0), 0);

    const sum = carry + commercial;
    const trays = Math.floor(sum / 20);
    const remainder = sum % 20;

    e.commercial = commercial;
    e.trays = trays;
    e.remainder = remainder;
    e.carryIn = carry;
    e.sum = sum;

    totalTrays += trays;
    carry = remainder;
  });

  eggsCarry.carry = carry;
  eggsCarry.totalTrays = totalTrays;

  localStorage.setItem("eggs", JSON.stringify(eggs));
  localStorage.setItem("eggsCarry", JSON.stringify(eggsCarry));
}

function saveEggRecord() {
  const date = eggsDate.value || new Date().toISOString().slice(0, 10);

  eggs[date] = {
    good: Number(eggsGood.value) || 0,
    bad: Number(eggsBad.value) || 0,
    home: Number(eggsHome.value) || 0
  };

  recomputeEggsAccumulation();

  const e = eggs[date];
  eggsInfo.innerHTML =
    e.sum < 20
      ? `ü•ö ${e.sum} —è—î—Ü—å (–¥–æ –ª–æ—Ç–∫–∞ –±—Ä–∞–∫—É—î ${20 - e.sum})`
      : `üì¶ ${e.trays} –ª–æ—Ç–∫—ñ–≤, –∑–∞–ª–∏—à–æ–∫ ${e.remainder}`;

  renderEggsReport();
}

window.saveEggRecord = saveEggRecord;

function renderEggsReport() {
  const list = document.getElementById("eggsList");
  if (!list) return;

  const dates = Object.keys(eggs).sort().reverse();
  if (!dates.length) {
    list.innerHTML = "<i>–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î</i>";
    return;
  }

  list.innerHTML = dates.map(d => {
    const e = eggs[d];
    return `
      <div class="egg-entry">
        <b>${d}</b><br>
        –í—Å—å–æ–≥–æ: ${e.good} | –ë—Ä–∞–∫: ${e.bad} | –î–ª—è –¥–æ–º—É: ${e.home}<br>
        –†–∞–∑–æ–º: ${e.sum} ‚Üí –õ–æ—Ç–∫–∏: ${e.trays}, –∑–∞–ª–∏—à–æ–∫: ${e.remainder}
      </div>`;
  }).join("");
}

// üóëÔ∏è –û–ß–ò–°–¢–ö–ê –í–°–¨–û–ì–û –ó–í–Ü–¢–£ ‚Äî –û–¶–ï –ì–û–õ–û–í–ù–ï
function clearAllEggs() {
  if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –í–ï–°–¨ —â–æ–¥–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç –ø–æ —è–π—Ü—è—Ö?")) return;

  eggs = {};
  eggsCarry = { carry: 0, totalTrays: 0 };

  localStorage.setItem("eggs", JSON.stringify(eggs));
  localStorage.setItem("eggsCarry", JSON.stringify(eggsCarry));

  renderEggsReport();
  document.getElementById("eggsInfo").innerHTML = "";
}

window.clearAllEggs = clearAllEggs;

// —Å—Ç–∞—Ä—Ç
recomputeEggsAccumulation();
renderEggsReport();