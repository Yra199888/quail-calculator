<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<title>Quail Farm Tools PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* === –ì–õ–û–ë–ê–õ–¨–ù–Ü –¢–ï–ú–ò === */
:root {
    --bg: #111;
    --text: #fff;
    --card: #1b1b1b;
    --border: #333;
    --accent: #4caf50;
}
.light {
    --bg: #f3f3f3;
    --text: #111;
    --card: #fff;
    --border: #ccc;
    --accent: #2a7cda;
}

body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: Arial, sans-serif;
    transition: 0.3s;
}

/* === –í–ï–†–•–ù–Ü –í–ö–õ–ê–î–ö–ò (C) === */
.topnav {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: var(--card);
    border-bottom: 2px solid var(--border);
    padding-top: 10px;
}
.tab-btn {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 18px;
    cursor: pointer;
    color: var(--text);
    border-bottom: 4px solid transparent;
}
.tab-btn.active {
    font-weight: bold;
    color: var(--accent);
    border-bottom: 4px solid var(--accent);
}

/* === –ö–û–ù–¢–ï–ô–ù–ï–†–ò –°–¢–û–†–Ü–ù–û–ö === */
.page {
    display: none;
    padding: 20px;
    padding-bottom: 80px;
}
.active-page {
    display: block;
}

.container {
    background: var(--card);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid var(--border);
    max-width: 900px;
    margin: 20px auto;
}

/* === –°–ü–û–í–Ü–©–ï–ù–ù–Ø –ó–ë–ï–†–ï–ñ–ï–ù–û === */
#saveAlert {
    position: fixed;
    top: 15px;
    right: 20px;
    background: var(--accent);
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    opacity: 0;
    transition: 0.4s;
    z-index: 999;
}
#saveAlert.show {
    opacity: 1;
}

/* === –ü–Ü–î–°–í–Ü–¢–ö–ê –†–Ø–î–ö–ê === */
.row-highlight {
    background: #2ecc71 !important;
    transition: background 0.5s ease;
}

/* === –ö–ù–û–ü–ö–ò === */
button, .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
}
button:hover, .btn:hover {
    opacity: 0.9;
}
.btn-small {
    padding: 5px 10px;
    font-size: 13px;
}

/* === –¢–ê–ë–õ–ò–¶–Ü === */
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid var(--border);
    padding: 8px;
    text-align: center;
}
th {
    background: var(--accent);
    color: #fff;
}

/* === –ü–û–õ–Ø –í–í–û–î–£ === */
input, textarea, select {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    margin-top: 6px;
    background: #0005;
    border: 1px solid var(--border);
    color: var(--text);
    box-sizing: border-box;
}

/* === –°–¢–ê–¢–£–°–ò –ó–ê–ú–û–í–õ–ï–ù–¨ === */
.status-active {
    color: #4caf50;
    font-weight: bold;
}
.status-completed {
    color: #3498db;
    font-weight: bold;
}
.status-cancelled {
    color: #e74c3c;
    font-weight: bold;
}

.order-item {
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 8px;
    background: #0004;
    border: 1px solid var(--border);
}
.order-date-title {
    font-size: 20px;
    margin-top: 25px;
}

/* === –§–Ü–ù–ê–ù–°–ò === */
.finance-summary p {
    margin: 4px 0;
}
.csv-btn {
    background: #2196f3;
    margin-top: 10px;
}

/* === –Ø–ô–¶–Ø ‚Äî –∑–≤—ñ—Ç === */
.eggs-day-block {
    padding: 10px;
    margin-bottom: 10px;
    background: #0004;
    border-radius: 8px;
    border: 1px solid var(--border);
}
.eggs-day-header {
    font-weight: bold;
    margin-bottom: 5px;
}
</style>
</head>

<body>

<!-- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
<div id="saveAlert">–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úîÔ∏è</div>

<!-- –ó–≤—É–∫ -->
<audio id="blipSound">
    <source src="data:audio/wav;base64,UklGRuQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YcQAAACQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQ==" type="audio/wav">
</audio>

<!-- –í–µ—Ä—Ö–Ω—ñ –≤–∫–ª–∞–¥–∫–∏ -->
<div class="topnav">
    <div class="tab-btn active" onclick="openTab('calculator', this)">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
    <div class="tab-btn" onclick="openTab('eggs', this)">ü•ö –Ø–π—Ü—è</div>
    <div class="tab-btn" onclick="openTab('orders', this)">üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
    <div class="tab-btn" onclick="openTab('finance', this)">üí∞ –§—ñ–Ω–∞–Ω—Å–∏</div>
</div>

<!-- ========= –°–¢–û–†–Ü–ù–ö–ê 1: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ========= -->
<div id="page-calculator" class="page active-page">
    <h2 style="text-align:center;">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ—Ä–º—É</h2>

    <div class="container">
        <table>
            <tr>
                <th>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</th>
                <th>–ö-—Å—Ç—å (–∫–≥)</th>
                <th>–¶—ñ–Ω–∞ –∑–∞ –∫–≥</th>
                <th>–°—É–º–∞</th>
            </tr>
        </table>

        <table id="feedTable"></table>

        <h3>–û–± º—î–º –∫–æ—Ä–º—É (–∫–≥):</h3>
        <input id="feedVolume" type="number" value="25" />

        <div class="result" style="margin-top:15px; font-size:18px; line-height:1.6;">
            –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: <b id="feedTotal">0</b> –≥—Ä–Ω<br />
            –¶—ñ–Ω–∞ –∑–∞ 1 –∫–≥: <b id="feedPerKg">0</b> –≥—Ä–Ω<br />
            –°—É–º–∞ –∑–∞ –æ–± º—î–º: <b id="feedVolumeTotal">0</b> –≥—Ä–Ω
        </div>
    </div>
</div>

<!-- ========= –°–¢–û–†–Ü–ù–ö–ê 2: –Ø–ô–¶–Ø ========= -->
<div id="page-eggs" class="page">
    <h2 style="text-align:center;">ü•ö –û–±–ª—ñ–∫ —è—î—Ü—å</h2>

    <div class="container">
        <h3>–î–æ–¥–∞—Ç–∏ / –æ–Ω–æ–≤–∏—Ç–∏ –∑–∞–ø–∏—Å –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h3>

        <label>–Ø—î—Ü—å –∑–∞ –¥–æ–±—É (–≤—Å—å–æ–≥–æ):</label>
        <input id="eggsGood" type="number" min="0" />

        <label>–ë—Ä–∞–∫–æ–≤–∞–Ω—ñ:</label>
        <input id="eggsBad" type="number" min="0" />

        <label>–î–ª—è –¥–æ–º—É:</label>
        <input id="eggsHome" type="number" min="0" />

        <button onclick="saveEggRecord()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å</button>

        <h3 style="margin-top:25px;">–ó–≤—ñ—Ç –ø–æ –¥–Ω—è—Ö</h3>
        <div id="eggsReport"></div>
    </div>
</div>

<!-- ========= –°–¢–û–†–Ü–ù–ö–ê 3: –ó–ê–ú–û–í–õ–ï–ù–ù–Ø ========= -->
<div id="page-orders" class="page">
    <h2 style="text-align:center;">üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>

    <div class="container">
        <h3>–ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø–æ –ª–æ—Ç–∫–∞—Ö</h3>
        <p>–ü–æ–≤–Ω–∏—Ö –ª–æ—Ç–∫—ñ–≤ (–ø–æ —è–π—Ü—è—Ö): <b id="summaryFullTrays">0</b></p>
        <p>–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ (active): <b id="summaryReservedTrays">0</b></p>
        <p>–í—ñ–ª—å–Ω—ñ –ª–æ—Ç–∫–∏: <b id="summaryFreeTrays">0</b></p>
        <p>–í–∏–∫–æ–Ω–∞–Ω–æ –ª–æ—Ç–∫—ñ–≤ (completed): <b id="summaryCompletedTrays">0</b></p>
    </div>

    <div class="container">
        <h3>–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>

        <label>–î–∞—Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</label>
        <input type="date" id="orderDate" />

        <label>–Ü–º'—è –∑–∞–º–æ–≤–Ω–∏–∫–∞:</label>
        <input type="text" id="orderName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –û–ª—è" />

        <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ª–æ—Ç–∫—ñ–≤:</label>
        <input type="number" id="orderTrays" min="1" />

        <label>–î–µ—Ç–∞–ª—ñ:</label>
        <textarea id="orderDetails" rows="3" placeholder="–ù–æ—Ç–∞—Ç–∫–∏..."></textarea>

        <button onclick="addOrder()">–î–æ–¥–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>

        <h3 style="margin-top:30px;">–£—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
        <div id="ordersList"></div>
    </div>
</div>

<!-- ========= –°–¢–û–†–Ü–ù–ö–ê 4: –§–Ü–ù–ê–ù–°–ò ========= -->
<div id="page-finance" class="page">
    <h2 style="text-align:center;">üí∞ –§—ñ–Ω–∞–Ω—Å–∏</h2>

    <div class="container">
        <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
        <label>–¶—ñ–Ω–∞ –∑–∞ –ª–æ—Ç–æ–∫ (20 —è—î—Ü—å), –≥—Ä–Ω:</label>
        <input id="trayPrice" type="number" min="0" placeholder="50" />
        <button onclick="saveTrayPrice()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>

        <h3 style="margin-top:25px;">–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∑–≤—ñ—Ç</h3>
        <div id="financeSummary" class="finance-summary"></div>

        <h3 style="margin-top:25px;">–ï–∫—Å–ø–æ—Ä—Ç –∑–≤—ñ—Ç—É</h3>
        <button class="csv-btn" onclick="exportCSV()">–ï–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
    </div>
</div>

<script>
/* ===================== –°–¢–ê–ù –î–ê–ù–ò–• ===================== */
let eggsLog = {};    // {date: {good,bad,home,sell}}
let orders = [];     // [{id,date,name,trays,details,status}]
let trayPrice = 0;   // –≥—Ä–Ω –∑–∞ –ª–æ—Ç–æ–∫

/* ===================== –í–ö–õ–ê–î–ö–ò ===================== */
function openTab(tab, btn) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active-page"));
    document.getElementById("page-" + tab).classList.add("active-page");

    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}

/* ===================== –°–ü–û–í–Ü–©–ï–ù–ù–Ø + –ó–í–£–ö ===================== */
function blip() {
    const s = document.getElementById("blipSound");
    if (!s) return;
    s.currentTime = 0;
    s.volume = 0.25;
    s.play().catch(() => {});
}
function alertSaved() {
    const box = document.getElementById("saveAlert");
    box.classList.add("show");
    setTimeout(() => box.classList.remove("show"), 900);
}

/* ===================== –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –ö–û–†–ú–£ ===================== */
const feedComponents = [
    ["–ö—É–∫—É—Ä—É–¥–∑–∞", 10],
    ["–ü—à–µ–Ω–∏—Ü—è", 5],
    ["–Ø—á–º—ñ–Ω—å", 1.5],
    ["–°–æ—î–≤–∞ –º–∞–∫—É—Ö–∞", 3],
    ["–°–æ–Ω—è—à–Ω–∏–∫–æ–≤–∞ –º–∞–∫—É—Ö–∞", 2.5],
    ["–†–∏–±–Ω–µ –±–æ—Ä–æ—à–Ω–æ", 1],
    ["–ö–æ—Ä–º–æ–≤—ñ –¥—Ä—ñ–∂–¥–∂—ñ", 0.7],
    ["–¢—Ä–∏–∫–∞–ª—å—Ü—ñ–π—Ñ–æ—Å—Ñ–∞—Ç", 0.5],
    ["Dolfos D", 0.7],
    ["–°—ñ–ª—å", 0.05]
];

function loadFeedTable() {
    let html = "";
    feedComponents.forEach((c, i) => {
        let qty = c[1];
        let price = localStorage.getItem("feed_p_" + i) || 0;
        html += `
        <tr id="feedRow${i}">
            <td>${c[0]}</td>
            <td><input id="feedQty${i}" type="number" value="${qty}" step="0.1" /></td>
            <td><input id="feedPrice${i}" type="number" value="${price}" step="0.1" /></td>
            <td id="feedSum${i}">0</td>
        </tr>`;
    });
    document.getElementById("feedTable").innerHTML = html;
}
function calcFeed() {
    let total = 0;
    let kgTotal = 0;

    feedComponents.forEach((c, i) => {
        let qty = Number(document.getElementById("feedQty" + i).value) || 0;
        let price = Number(document.getElementById("feedPrice" + i).value) || 0;
        localStorage.setItem("feed_p_" + i, price);

        let sum = qty * price;
        document.getElementById("feedSum" + i).textContent = sum.toFixed(2);

        total += sum;
        kgTotal += qty;

        const row = document.getElementById("feedRow" + i);
        row.classList.add("row-highlight");
        setTimeout(() => row.classList.remove("row-highlight"), 300);
    });

    const perkg = kgTotal ? total / kgTotal : 0;
    const vol = Number(document.getElementById("feedVolume").value) || 0;
    const volTotal = perkg * vol;

    document.getElementById("feedTotal").textContent = total.toFixed(2);
    document.getElementById("feedPerKg").textContent = perkg.toFixed(2);
    document.getElementById("feedVolumeTotal").textContent = volTotal.toFixed(2);

    blip();
    alertSaved();
}

/* ===================== –Ø–ô–¶–Ø ===================== */
// –∑—á–∏—Ç–∞—Ç–∏ eggsLog –∑ localStorage
function loadEggsLog() {
    try {
        eggsLog = JSON.parse(localStorage.getItem("eggsLog") || "{}");
    } catch {
        eggsLog = {};
    }
}
function saveEggsLog() {
    localStorage.setItem("eggsLog", JSON.stringify(eggsLog));
}

// –∑–∞–≥–∞–ª—å–Ω—ñ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–∏ –ø–æ —è–π—Ü—è—Ö
function getEggsTotals() {
    let totalCommercial = 0;
    for (const d in eggsLog) {
        totalCommercial += eggsLog[d].sell || 0;
    }
    const totalFullTrays = Math.floor(totalCommercial / 20);
    return { totalCommercial, totalFullTrays };
}

// –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ (A ‚Äî –æ–¥–∏–Ω –∑–∞–ø–∏—Å –Ω–∞ –¥–µ–Ω—å)
function saveEggRecord() {
    const good = Math.max(0, Number(document.getElementById("eggsGood").value) || 0);
    const bad  = Math.max(0, Number(document.getElementById("eggsBad").value) || 0);
    const home = Math.max(0, Number(document.getElementById("eggsHome").value) || 0);

    const sell = Math.max(0, good - bad - home);

    const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    eggsLog[today] = { good, bad, home, sell };

    saveEggsLog();
    blip();
    alertSaved();
    renderEggsReport();
    updateOrdersSummary();
    renderFinance();
}

// –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å –∑–∞ –¥–µ–Ω—å
function deleteEggRecord(date) {
    delete eggsLog[date];
    saveEggsLog();
    renderEggsReport();
    updateOrdersSummary();
    renderFinance();
}

// —Ä–µ–Ω–¥–µ—Ä –∑–≤—ñ—Ç—É –ø–æ –¥–Ω—è—Ö
function renderEggsReport() {
    const container = document.getElementById("eggsReport");
    container.innerHTML = "";

    const dates = Object.keys(eggsLog).sort().reverse(); // –≤—ñ–¥ –Ω–æ–≤–∏—Ö –¥–æ —Å—Ç–∞—Ä–∏—Ö

    if (dates.length === 0) {
        container.textContent = "–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.";
        return;
    }

    dates.forEach(date => {
        const rec = eggsLog[date];
        const sell = rec.sell || 0;
        const fullTrays = Math.floor(sell / 20);

        const div = document.createElement("div");
        div.className = "eggs-day-block";

        const humanDate = date.split("-").reverse().join(".");

        div.innerHTML = `
            <div class="eggs-day-header">üìÖ ${humanDate}</div>
            <div>–í—Å—å–æ–≥–æ: <b>${rec.good}</b></div>
            <div>–ë—Ä–∞–∫: <b>${rec.bad}</b></div>
            <div>–î–ª—è –¥–æ–º—É: <b>${rec.home}</b></div>
            <div>–ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ: <b>${sell}</b></div>
            <div>–ü–æ–≤–Ω–∏—Ö –ª–æ—Ç–∫—ñ–≤: <b>${fullTrays}</b></div>
            <button class="btn-small" onclick="deleteEggRecord('${date}')">–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å</button>
        `;
        container.appendChild(div);
    });
}

/* ===================== –ó–ê–ú–û–í–õ–ï–ù–ù–Ø ===================== */
function loadOrders() {
    try {
        orders = JSON.parse(localStorage.getItem("ordersLog") || "[]");
    } catch {
        orders = [];
    }
}
function saveOrders() {
    localStorage.setItem("ordersLog", JSON.stringify(orders));
}

// –¥–æ–¥–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
function addOrder() {
    const dateInput = document.getElementById("orderDate").value;
    const name = (document.getElementById("orderName").value || "").trim();
    const trays = Number(document.getElementById("orderTrays").value) || 0;
    const details = (document.getElementById("orderDetails").value || "").trim();

    if (!name || trays <= 0) {
        alert("–í–≤–µ–¥–∏ —ñ–º º—è —ñ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ª–æ—Ç–∫—ñ–≤ –±—ñ–ª—å—à–µ –Ω—É–ª—è.");
        return;
    }

    const date = dateInput || new Date().toISOString().slice(0,10);

    const order = {
        id: Date.now(),
        date,
        name,
        trays,
        details,
        status: "active"
    };

    orders.push(order);
    saveOrders();
    blip();
    alertSaved();

    // –æ—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É
    document.getElementById("orderName").value = "";
    document.getElementById("orderTrays").value = "";
    document.getElementById("orderDetails").value = "";

    renderOrders();
    updateOrdersSummary();
    renderFinance();
}

// –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
function setOrderStatus(id, status) {
    orders = orders.map(o => o.id === id ? {...o, status} : o);
    saveOrders();
    blip();
    alertSaved();
    renderOrders();
    updateOrdersSummary();
    renderFinance();
}

// –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
function deleteOrder(id) {
    orders = orders.filter(o => o.id !== id);
    saveOrders();
    blip();
    alertSaved();
    renderOrders();
    updateOrdersSummary();
    renderFinance();
}

// –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö
function getOrdersStats() {
    let reserved = 0;
    let completed = 0;
    let cancelled = 0;

    orders.forEach(o => {
        if (o.status === "active")    reserved  += o.trays;
        if (o.status === "completed") completed += o.trays;
        if (o.status === "cancelled") cancelled += o.trays;
    });

    return { reserved, completed, cancelled };
}

// —Ä–µ–Ω–¥–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω—å (B: –ø–æ –¥–∞—Ç–∞—Ö, –¥–µ—Ç–∞–ª—ñ –≤–∏–¥–Ω–æ –æ–¥—Ä–∞–∑—É, –≤—Å—ñ —Ä–∞–∑–æ–º)
function renderOrders() {
    const container = document.getElementById("ordersList");
    container.innerHTML = "";

    if (orders.length === 0) {
        container.textContent = "–ü–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å.";
        return;
    }

    // –≥—Ä—É–ø—É—î–º–æ –ø–æ –¥–∞—Ç–∞—Ö
    const byDate = {};
    orders.forEach(o => {
        if (!byDate[o.date]) byDate[o.date] = [];
        byDate[o.date].push(o);
    });

    const dates = Object.keys(byDate).sort().reverse();

    dates.forEach(date => {
        const humanDate = date.split("-").reverse().join(".");
        const h = document.createElement("div");
        h.className = "order-date-title";
        h.textContent = "üìÖ " + humanDate;
        container.appendChild(h);

        byDate[date].forEach(o => {
            const div = document.createElement("div");
            div.className = "order-item";

            const statusClass =
                o.status === "completed" ? "status-completed" :
                o.status === "cancelled" ? "status-cancelled" :
                "status-active";

            const statusLabel =
                o.status === "completed" ? "Completed" :
                o.status === "cancelled" ? "Cancelled" :
                "Active";

            div.innerHTML = `
                <div><b>${o.name}</b> ‚Äî ${o.trays} –ª–æ—Ç–∫—ñ–≤</div>
                <div>–î–µ—Ç–∞–ª—ñ: ${o.details || "-"}</div>
                <div>–°—Ç–∞—Ç—É—Å: <span class="${statusClass}">${statusLabel}</span></div>
                <div style="margin-top:8px;">
                    <button class="btn-small" onclick="setOrderStatus(${o.id}, 'active')">Active</button>
                    <button class="btn-small" onclick="setOrderStatus(${o.id}, 'completed')">–í–∏–∫–æ–Ω–∞–Ω–æ</button>
                    <button class="btn-small" onclick="setOrderStatus(${o.id}, 'cancelled')">–°–∫–∞—Å–æ–≤–∞–Ω–æ</button>
                    <button class="btn-small" onclick="deleteOrder(${o.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </div>
            `;
            container.appendChild(div);
        });
    });
}

// –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–µ—Ä—Ö–Ω—å–æ–≥–æ summary –ø–æ –ª–æ—Ç–∫–∞—Ö —É –≤–∫–ª–∞–¥—Ü—ñ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
function updateOrdersSummary() {
    const eggsTotals = getEggsTotals();
    const orderStats = getOrdersStats();

    const fullTrays = eggsTotals.totalFullTrays;
    const reserved  = orderStats.reserved;
    const completed = orderStats.completed;
    let free = fullTrays - reserved;
    if (free < 0) free = 0;

    document.getElementById("summaryFullTrays").textContent = fullTrays;
    document.getElementById("summaryReservedTrays").textContent = reserved;
    document.getElementById("summaryFreeTrays").textContent = free;
    document.getElementById("summaryCompletedTrays").textContent = completed;
}

/* ===================== –§–Ü–ù–ê–ù–°–ò ===================== */
function loadFinanceSettings() {
    try {
        const obj = JSON.parse(localStorage.getItem("financeSettings") || "{}");
        trayPrice = obj.trayPrice || 0;
    } catch {
        trayPrice = 0;
    }
}
function saveFinanceSettings() {
    localStorage.setItem("financeSettings", JSON.stringify({ trayPrice }));
}

// –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ü—ñ–Ω–∏ –∑–∞ –ª–æ—Ç–æ–∫
function saveTrayPrice() {
    trayPrice = Number(document.getElementById("trayPrice").value) || 0;
    saveFinanceSettings();
    blip();
    alertSaved();
    renderFinance();
}

// —Ä–µ–Ω–¥–µ—Ä —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–≤—ñ—Ç—É (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π)
function renderFinance() {
    const div = document.getElementById("financeSummary");
    div.innerHTML = "";

    const eggsTotals = getEggsTotals();
    const orderStats = getOrdersStats();

    const totalCommercial = eggsTotals.totalCommercial;
    const totalFullTrays  = eggsTotals.totalFullTrays;
    const reserved        = orderStats.reserved;
    const completed       = orderStats.completed;

    const incomeCompleted = completed * trayPrice;
    const potentialIncome = totalFullTrays * trayPrice;

    const html = `
        <p>–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∏—Ö —è—î—Ü—å –≤—Å—å–æ–≥–æ: <b>${totalCommercial}</b></p>
        <p>–ü–æ–≤–Ω–∏—Ö –ª–æ—Ç–∫—ñ–≤ (–ø–æ —è–π—Ü—è—Ö): <b>${totalFullTrays}</b></p>
        <p>–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ –ª–æ—Ç–∫—ñ–≤ (Active): <b>${reserved}</b></p>
        <p>–í–∏–∫–æ–Ω–∞–Ω–æ –ª–æ—Ç–∫—ñ–≤ (Completed): <b>${completed}</b></p>
        <hr/>
        <p>–¶—ñ–Ω–∞ –∑–∞ –ª–æ—Ç–æ–∫: <b>${trayPrice.toFixed(2)}</b> –≥—Ä–Ω</p>
        <p>–î–æ—Ö—ñ–¥ –∑ –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å: <b>${incomeCompleted.toFixed(2)}</b> –≥—Ä–Ω</p>
        <p>–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –¥–æ—Ö—ñ–¥ (—è–∫—â–æ –ø—Ä–æ–¥–∞—Ç–∏ –≤—Å—ñ –ª–æ—Ç–∫–∏): <b>${potentialIncome.toFixed(2)}</b> –≥—Ä–Ω</p>
    `;
    div.innerHTML = html;
}

// –µ–∫—Å–ø–æ—Ä—Ç CSV (—è–π—Ü—è + –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è + —Ñ—ñ–Ω–∞–Ω—Å–∏)
function exportCSV() {
    const lines = [];

    // –Ø–ô–¶–Ø
    lines.push("=== –Ø–ô–¶–Ø ===");
    lines.push("–î–∞—Ç–∞;–í—Å—å–æ–≥–æ;–ë—Ä–∞–∫;–î–ª—è –¥–æ–º—É;–ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ;–ü–æ–≤–Ω–∏—Ö –ª–æ—Ç–∫—ñ–≤");
    const dates = Object.keys(eggsLog).sort();
    dates.forEach(d => {
        const r = eggsLog[d];
        const sell = r.sell || 0;
        const full = Math.floor(sell / 20);
        const humanDate = d.split("-").reverse().join(".");
        lines.push(`${humanDate};${r.good};${r.bad};${r.home};${sell};${full}`);
    });

    lines.push("");
    lines.push("=== –ó–ê–ú–û–í–õ–ï–ù–ù–Ø ===");
    lines.push("–î–∞—Ç–∞;–Ü–º º—è;–õ–æ—Ç–∫–∏;–°—Ç–∞—Ç—É—Å;–î–µ—Ç–∞–ª—ñ");
    orders.forEach(o => {
        const humanDate = o.date.split("-").reverse().join(".");
        lines.push(`${humanDate};${o.name};${o.trays};${o.status};${(o.details || "").replace(/;/g, ",")}`);
    });

    const eggsTotals = getEggsTotals();
    const orderStats = getOrdersStats();
    const incomeCompleted = orderStats.completed * trayPrice;
    const potentialIncome = eggsTotals.totalFullTrays * trayPrice;

    lines.push("");
    lines.push("=== –§–Ü–ù–ê–ù–°–ò ===");
    lines.push(`–¶—ñ–Ω–∞ –∑–∞ –ª–æ—Ç–æ–∫;${trayPrice}`);
    lines.push(`–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∏—Ö —è—î—Ü—å –≤—Å—å–æ–≥–æ;${eggsTotals.totalCommercial}`);
    lines.push(`–ü–æ–≤–Ω–∏—Ö –ª–æ—Ç–∫—ñ–≤;${eggsTotals.totalFullTrays}`);
    lines.push(`–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ –ª–æ—Ç–∫—ñ–≤;${orderStats.reserved}`);
    lines.push(`–í–∏–∫–æ–Ω–∞–Ω–æ –ª–æ—Ç–∫—ñ–≤;${orderStats.completed}`);
    lines.push(`–î–æ—Ö—ñ–¥ –∑ –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö;${incomeCompleted.toFixed(2)}`);
    lines.push(`–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –¥–æ—Ö—ñ–¥;${potentialIncome.toFixed(2)}`);

    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "quail_farm_report.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* ===================== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ===================== */
document.addEventListener("DOMContentLoaded", () => {
    // –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    loadFeedTable();
    document.addEventListener("input", (e) => {
        if (e.target.id.startsWith("feedQty") || e.target.id.startsWith("feedPrice") || e.target.id === "feedVolume") {
            calcFeed();
        }
    });
    calcFeed();

    // —è–π—Ü—è
    loadEggsLog();
    renderEggsReport();

    // –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    loadOrders();
    renderOrders();

    // —Ñ—ñ–Ω–∞–Ω—Å–∏
    loadFinanceSettings();
    document.getElementById("trayPrice").value = trayPrice || "";
    updateOrdersSummary();
    renderFinance();

    // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—è –¥–∞—Ç–∞ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö
    const today = new Date().toISOString().slice(0,10);
    const dateInput = document.getElementById("orderDate");
    if (dateInput && !dateInput.value) {
        dateInput.value = today;
    }
});
</script>

</body>
</html>